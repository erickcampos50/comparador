<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>

<HEAD>
  <TITLE>Comparador de versões de documentos</TITLE>
  <!-- Include Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <SCRIPT SRC="https://neil.fraser.name/software/diff_match_patch/javascript/diff_match_patch.js"></SCRIPT>
</HEAD>


<SCRIPT>
var dmp = new diff_match_patch();

function launch() {
  var text1 = document.getElementById('text1').value;
  var text2 = document.getElementById('text2').value;
  dmp.Diff_Timeout = parseFloat(document.getElementById('timeout').value);
  dmp.Diff_EditCost = parseFloat(document.getElementById('editcost').value);

  var ms_start = (new Date()).getTime();
  var d = dmp.diff_main(text1, text2);
  var ms_end = (new Date()).getTime();

  if (document.getElementById('semantic').checked) {
    dmp.diff_cleanupSemantic(d);
  }
  if (document.getElementById('efficiency').checked) {
    dmp.diff_cleanupEfficiency(d);
  }
  var ds = dmp.diff_prettyHtml(d);


//Aplica a cor definida pelo usuário  
  var colorAdd = document.getElementById('colorPickerAdd').value;
  ds = ds.replace(/<ins style="background:#e6ffe6;">/g, '<ins style="color:'+colorAdd+';">');
  
  var colorSub = document.getElementById('colorPickerSub').value;
  ds = ds.replace(/<del style="background:#ffe6e6;">/g, '<del style="color:'+colorSub+';">');

//Remove a marcação de parágrafo da resposta  
  ds = ds.replace(/&para;/g, "");
  
  
  
  
  
  document.getElementById('outputdiv').innerHTML = ds + '<BR><P style="background:#e6ffe6;">Tempo de processamento da comparação: ' + (ms_end - ms_start) / 1000 + 's </P>';

  generateTable(ds)
  
  // Salva o resultado em uma variável global para uso posterior.
  window.diffResult = ds;
  
  
}

// Adiciona uma nova função para alterar a cor de fundo das tags ins e del.
function changeColorSub() {
  var color = document.getElementById('colorPickerSub').value;
  var re = /<del style="color:#.{6};">/g;
  window.diffResult = window.diffResult.replace(re, `<del style="color:${color};">`);
  document.getElementById('outputdiv').innerHTML = window.diffResult;
}

function changeColorAdd() {
  var color = document.getElementById('colorPickerAdd').value;
  var re = /<ins style="color:#.{6};">/g;
  window.diffResult = window.diffResult.replace(re, `<ins style="color:${color};">`);
  document.getElementById('outputdiv').innerHTML = window.diffResult;
}

function downloadHtml() {
  // Cria uma nova data e formata como uma string no formato 'yyyy-mm-dd_hh-mm-ss'
  var now = new Date();
  var formattedDate = now.getFullYear() + '-' + (now.getMonth() + 1).toString().padStart(2, '0') + '-' +
    now.getDate().toString().padStart(2, '0') + '_' + now.getHours().toString().padStart(2, '0') + '-' +
    now.getMinutes().toString().padStart(2, '0') + '-' + now.getSeconds().toString().padStart(2, '0');

  var blob = new Blob([convertHtml(window.diffResult)], {type: 'text/html'});
  // Define "Comparacao_" + a data atual formatada como o valor padrão para o nome do arquivo
  var fileName = prompt("Digite o nome do arquivo:", "Comparacao_" + formattedDate);
  if (fileName) {
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
    URL.revokeObjectURL(link.href);
  }
}




function addStyles() {
    var style = document.createElement('style');
    style.innerHTML = `
    .deletado {
        background: #9ac775;
        text-decoration: line-through;
    }
    .inserido {
        background: #f56666;
        text-decoration: underline;
    }`;
    document.head.appendChild(style);
}

function convertHtml(originalHtml) {
  // Cria um novo objeto DOM a partir da string HTML
  const parser = new DOMParser();
  const doc = parser.parseFromString(originalHtml, 'text/html');

  // Seleciona todos os elementos 'del' e 'ins' e adiciona as classes CSS apropriadas
  const elements = doc.querySelectorAll('del, ins');
  elements.forEach(element => {
    const newElement = document.createElement('span');
    newElement.className = element.tagName.toLowerCase() === 'del' ? 'deletado' : 'inserido';
    newElement.innerHTML = element.innerHTML;

    // Substitui o elemento antigo pelo novo no DOM
    element.parentNode.replaceChild(newElement, element);
  });

  var colorAdd = document.getElementById('colorPickerAdd').value;
  var colorSub = document.getElementById('colorPickerSub').value;

  // Retorna o HTML corrigido
  const estilo = '\n<style> .deletado { color:'+colorSub+'; text-decoration: line-through; } .inserido { color:'+colorAdd+'; text-decoration: underline; } .caixa-colorida { background-color: #f5f5f5; padding: 10px; border-radius: 10px; } </style>\n';
  const begin = '<!DOCTYPE html>\n<html lang="pt-br">\n<head>\n' +
        '<meta charset="UTF-8">\n<title>Resultado da comparação</title>\n' +
        '</head>\n<body><div class="caixa-colorida"><H3>Abra este arquivo no LibreOffice Writer para conseguir copiar e colar o conteúdo nos sistemas do Compras.gov.br sem perda de formatação (testado no LibreOffice 7.5.0.3)</H3></div>\n<p>\n';
  const end = '\n</p>\n</body>\n</html>';
    
  return begin + estilo + doc.body.innerHTML + end;
}


function generateTable(ds) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(ds, 'text/html');

    // Seleciona todos os elementos 'del' e 'ins'
    const elements = doc.querySelectorAll('del, ins');

    // Cria a tabela
    let tabela = '<table><thead><tr><th>Texto</th><th>Tipo de modificação</th><th>Justificativa</th></tr></thead><tbody>';

    // Itera pelos elementos selecionados
    elements.forEach(element => {
        const tipo = element.tagName.toLowerCase() === 'del' ? 'Suprimido' : 'Adicionado';
        tabela += `<tr><td>${element.innerHTML}</td><td>${tipo}</td><td></td></tr>`;
    });

    tabela += '</tbody></table>';

    // Adiciona um estilo CSS
    let style = `<style>
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        padding: 15px;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>`;

    let html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Tabela de Modificações</title>
        ${style}
      </head>
      <body>
        ${tabela}
      </body>
      </html>`;


	
	
	document.getElementById('tabelaModificacoes').innerHTML = html
	
}


function exportTable(ds) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(ds, 'text/html');

    // Seleciona todos os elementos 'del' e 'ins'
    const elements = doc.querySelectorAll('del, ins');

    // Cria a tabela
    let tabela = '<table><thead><tr><th>Texto</th><th>Tipo de modificação</th><th>Justificativa</th></tr></thead><tbody>';

    // Itera pelos elementos selecionados
    elements.forEach(element => {
        const tipo = element.tagName.toLowerCase() === 'del' ? 'Suprimido' : 'Adicionado';
        tabela += `<tr><td>${element.innerHTML}</td><td>${tipo}</td><td></td></tr>`;
    });

    tabela += '</tbody></table>';

    // Adiciona um estilo CSS
    let style = `<style>
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        padding: 15px;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
      }
    </style>`;

    let html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Tabela de Modificações</title>
        ${style}
      </head>
      <body>
        ${tabela}
      </body>
      </html>`;

    // Gera o arquivo HTML
    const blob = new Blob([html], {type: 'text/html'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'tabela.html';
    link.click();
    URL.revokeObjectURL(link.href);
	
	

}



function loadReferenceFile() {
  var selectedFile = document.getElementById('selectReference').value;
  if (!selectedFile) return; // Se não houver arquivo selecionado, simplesmente retorne
  
   var url = "https://raw.githubusercontent.com/erickcampos50/comparador/main/referencias/" + selectedFile;
   
   
  // Realizar uma solicitação HTTP para obter o conteúdo do arquivo
  fetch(url)
    .then(response => response.arrayBuffer())
    .then(arrayBuffer => {
      // Usar o TextDecoder para interpretar corretamente os caracteres latinos
      var decoder = new TextDecoder('iso-8859-1');
      var text = decoder.decode(arrayBuffer);
      
      // Inserir o conteúdo do arquivo no elemento "text1"
      document.getElementById('text1').value = text;
    })
    .catch(error => {
      alert('Erro ao carregar o arquivo: ' + error);
    });
}


</SCRIPT>

<BODY>
  <div class="container mt-5">
    <H1>Comparador de versões de documentos para submissão à AGU</H1>

    <P>Diante da determinação de sinalização visual de todas as alterações em documentos licitatórios submetidos à AGU
      (Termo de referência, Contrato, Edital, etc.), surgiu a necessidade de encontrar um recurso simples e flexível
      para automatizar a nova atividade (que pode ser bastante extenuante e propensa a erros). Este Webapp permite
      comparar as modificações entre dois textos utilizando o excelente <A
        HREF="https://github.com/google/diff-match-patch">Diff, Match e Patch</A>.</P>

    <FORM action="#" onsubmit="return false">

      <H3>Selecionar modelo da AGU (disponíveis em 01/08/2023):</H3>
      <select id="selectReference" class="form-control mb-3" onchange="loadReferenceFile()">
        <option value="">Escolha uma opção...</option>
        <option value="Lista de Verificação Compras e Serviços Sem Mão de Obra Lei 14.133.txt">Lista de Verificação
          Compras e Serviços Sem Mão de Obra Lei 14.133</option>


    <option value="Lista de Verificação Compras e Serviços Sem Mão de Obra Lei 14.133.txt">Lista de Verificação Compras e Serviços Sem Mão de Obra Lei 14.133</option>
    <option value="Modelo de Contrato de Serviços Com Mão de Obra Lei 14.133.txt">Modelo de Contrato de Serviços Com Mão de Obra Lei 14.133</option>
    <option value="Modelo de Contrato Pregão Compras Lei 14.133.txt">Modelo de Contrato Pregão Compras Lei 14.133</option>
    <option value="Modelo de Contrato Serviços Comuns de Engenharia Lei 14.133.txt">Modelo de Contrato Serviços Comuns de Engenharia Lei 14.133</option>
    <option value="Modelo de Contrato Serviços Sem Mão de Obra Lei 14.133.txt">Modelo de Contrato Serviços Sem Mão de Obra Lei 14.133</option>
    <option value="Modelo de Edital de Concorrência Lei 14.133 .maio23.txt">Modelo de Edital de Concorrência Lei 14.133 .maio23</option>
    <option value="Modelo e Ata de Registro de Preços Lei 14.133 maio23.txt">Modelo e Ata de Registro de Preços Lei 14.133 maio23</option>
    <option value="Modelo Edital Pregão SRP Lei 14.133.txt">Modelo Edital Pregão SRP Lei 14.133</option>
    <option value="Parecer Parametrizado Compras e Serviços Sem Mão de Obra Lei 14.133.txt">Parecer Parametrizado Compras e Serviços Sem Mão de Obra Lei 14.133</option>
    <option value="Termo de Justificativas Técnicas Relevantes obras e serviços de engenharia (ATUALIZADO SET-2021).txt">Termo de Justificativas Técnicas Relevantes obras e serviços de engenharia (ATUALIZADO SET-2021)</option>
    <option value="Termo de Referência Compras Lei 14.133.txt">Termo de Referência Compras Lei 14.133</option>
    <option value="Termo de Referência Pregão Engenharia Lei 14.133.txt">Termo de Referência Pregão Engenharia Lei 14.133</option>
    <option value="Termo de Referência Serviços Com Mão de Obra Lei 14.133.txt">Termo de Referência Serviços Com Mão de Obra Lei 14.133</option>
    <option value="Termo de Referência Serviços Sem Mão de Obra Lei 14.133.txt">Termo de Referência Serviços Sem Mão de Obra Lei 14.133</option>
  </select>



    <div class="row">
        <div class="col-md-6">
          <H3>Texto 1 (original da AGU):</H3>
          <TEXTAREA ID="text1" CLASS="form-control" ROWS=10>Este é um exemplo de texto, cole aqui a versão do Termo de
Referência, Contrato, Edital, etc. que você deseja usar como base para comparação. Estes arquivos estão geralmente em https://www.gov.br/agu/pt-br/composicao/cgu/cgu/modelos/licitacoesecontratos
Segue um texto para testes:
"Sou o modelo perfeito de um moderno compêndio,
Tenho informações vegetais, animais e minerais,
Conheço os reis da Inglaterra, e cito as lutas históricas,
De Maratona a Waterloo, em ordem categórica."</TEXTAREA>
        </div>
        <div class="col-md-6">
          <H3>Texto 2 (editado por você):</H3>
          <TEXTAREA ID="text2" CLASS="form-control" ROWS=10>Este é outro exemplo de texto, cole aqui a sua versão do
Termo de Referência, Contrato, Edital, etc. Segue um texto para testes:
Sou o modelo perfeito de um indivíduo de desenho animado,
Minha animação é cômica, incomum e caprichosa,
Sou muito bom em piadas engraçadas, li teoria cômica,
De trocadilhos maldosos e piadas estúpidas a bigornas que caem na sua cabeça.</TEXTAREA>
        </div>
      </div>

      <H3>Ajustes no tipo e resultados das comparações</H3>
      <P>
        Esta implementação funciona caracter por caracter, o que é ideal para identificar mudanças sutis nos textos, no
        entanto o resultado pode conter "exageros", ou seja, pequenas coincidências irrelevantes que complicam a leitura.
      </P>


<DL>
<DT><INPUT TYPE="radio" NAME="cleanup" ID="semantic" CHECKED>
<LABEL FOR="semantic">Limpeza Semântica</LABEL></DT>
<DD>Aumenta a legibilidade humana ao remover coincidências que provavelmente são
coincidentais.</DD>
<DT><INPUT TYPE="radio" NAME="cleanup" ID="efficiency">
<LABEL FOR="efficiency">Limpeza de Eficiência</LABEL>,
defina o nível: <INPUT TYPE="text" SIZE=3 MAXLENGTH=5 VALUE="10" ID="editcost">
<DD>Aumenta a eficiência computacional ao remover coincidências curtas que não justificam o tempo de processamento. Quanto maior o custo de edição, mais agressiva a limpeza.</DD>
<DT><INPUT TYPE="radio" NAME="cleanup" ID="raw">
<LABEL FOR="raw">Sem Limpeza</LABEL></DT>
<DD>Exibe a comparação sem modificações (saída bruta).</DD>
</DL>

<H3>Tempo limite de processamento da comparação:</H3>
<P><INPUT TYPE="text" SIZE=3 MAXLENGTH=5 VALUE="2" ID="timeout"> segundos<BR>
Se a fase de cálculo de diferenças levar mais tempo que isso, então o cálculo
é interrompido e a melhor solução até o momento é retornada. Este recurso é útil para comparações que estejam travando. Defina um tempo limite de '0' permite o melhor resultado possível independente do tempo.</P>


<H3>Modificar as cores:</H3>
<P>Escolha a cor para marcar todo o conteúdo <strong>adicionado</strong>: <input type="color" id="colorPickerAdd" value="#f56666" onchange="changeColorAdd()"></P>
<P>Escolha a cor para marcar todo o conteúdo <strong>removido ou substituído</strong>: <input type="color" id="colorPickerSub" value="#000000" onchange="changeColorSub()"></P>

<P><INPUT TYPE="button" onClick="launch()" VALUE="Gerar comparação e tabela com modificações"></P>
<P style="background:#e6ffe6;">Exporte o resultado em HTML e abra com o LibreOffice Writer caso o conteúdo esteja perdendo formatação ao colar no Compras.gov.br
</P>

<P><INPUT TYPE="button" onClick="downloadHtml()" VALUE="Exportar resultado como HTML">
<INPUT TYPE="button" onClick="exportTable(window.diffResult)" VALUE="Exportar tabela com modificações como HTML">
</P>

    </FORM>

    <div id="outputdiv"></div>
    <hr>
    <div id="tabelaModificacoes"></div>

  </div>
    <!-- Credits section -->
    <div class="mt-5 container ">
      <h3>Créditos:</h3>
      <p>
        Esta aplicação foi adaptada por <strong href="erick.campos@ufjf.br">Erick C. Campos</strong> para Universidade Federal de Juiz de Fora - Campus GV utilizando a excelente biblioteca <a href="https://github.com/google/diff-match-patch">Diff, Match e Patch</a> desenvolvida por Neil Fraser.
      </p>
      <p>
        
      </p>
    </div>

  </div>



  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</BODY>

</HTML>
