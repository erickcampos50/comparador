<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
  <TITLE>Comparador de versões de documentos</TITLE>
  <SCRIPT SRC="https://neil.fraser.name/software/diff_match_patch/javascript/diff_match_patch.js"></SCRIPT>
</HEAD>

<BODY>
<H1>Comparador de versões de documentos para submissão à AGU</H1>

<P>Diante da determinação de sinalização visual de todas as alterações em documentos licitatórios submetidos à AGU (Termo de referência, Contrato, Edital, etc.), surgiu a necessidade de encontrar um recurso simples e flexível para automatizar a nova atividade (que pode ser bastante extenuante e propensa a erros). Este Webapp permite comparar as modificações entre dois textos utilizando o excelente <A HREF="https://github.com/google/diff-match-patch">Diff, Match e Patch</A>.</P>


<SCRIPT>
var dmp = new diff_match_patch();

function launch() {
  var text1 = document.getElementById('text1').value;
  var text2 = document.getElementById('text2').value;
  dmp.Diff_Timeout = parseFloat(document.getElementById('timeout').value);
  dmp.Diff_EditCost = parseFloat(document.getElementById('editcost').value);

  var ms_start = (new Date()).getTime();
  var d = dmp.diff_main(text1, text2);
  var ms_end = (new Date()).getTime();

  if (document.getElementById('semantic').checked) {
    dmp.diff_cleanupSemantic(d);
  }
  if (document.getElementById('efficiency').checked) {
    dmp.diff_cleanupEfficiency(d);
  }
  var ds = dmp.diff_prettyHtml(d);
  
  var colorAdd = document.getElementById('colorPickerAdd').value;
  ds = ds.replace(/<ins style="background:#e6ffe6;">/g, '<ins style="background:'+colorAdd+';">');
  
  var colorSub = document.getElementById('colorPickerSub').value;
  ds = ds.replace(/<del style="background:#ffe6e6;">/g, '<del style="background:'+colorSub+';">');
  
  
  
  
  
  
  
  document.getElementById('outputdiv').innerHTML = ds + '<BR>Tempo: ' + (ms_end - ms_start) / 1000 + 's';

  // Salva o resultado em uma variável global para uso posterior.
  window.diffResult = ds;
}

// Adiciona uma nova função para alterar a cor de fundo das tags ins e del.
function changeColorSub() {
  var color = document.getElementById('colorPickerSub').value;
  var re = /<del style="background:#.{6};">/g;
  window.diffResult = window.diffResult.replace(re, `<del style="background:${color};">`);
  document.getElementById('outputdiv').innerHTML = window.diffResult;
}

function changeColorAdd() {
  var color = document.getElementById('colorPickerAdd').value;
  var re = /<ins style="background:#.{6};">/g;
  window.diffResult = window.diffResult.replace(re, `<ins style="background:${color};">`);
  document.getElementById('outputdiv').innerHTML = window.diffResult;
}

function downloadHtml() {
  var blob = new Blob([window.diffResult], {type: 'text/html'});
  var fileName = prompt("Digite o nome do arquivo:");
  if (fileName) {
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
    URL.revokeObjectURL(link.href);
  }
}
</SCRIPT>

<FORM action="#" onsubmit="return false">
<TABLE WIDTH="100%"><TR>
  <TD WIDTH="50%">
<H3>Versão do Texto 1:</H3>
<TEXTAREA ID="text1" STYLE="width: 100%" ROWS=10>Sou o modelo perfeito de um moderno Major-General,
Tenho informações vegetais, animais e minerais,
Conheço os reis da Inglaterra, e cito as lutas históricas,
De Maratona a Waterloo, em ordem categórica.</TEXTAREA></TD>
  <TD WIDTH="50%">
<H3>Versão do Texto 2:</H3>
<TEXTAREA ID="text2" STYLE="width: 100%" ROWS=10>Sou o modelo perfeito de um indivíduo de desenho animado,
Minha animação é cômica, incomum e caprichosa,
Sou muito bom em piadas engraçadas, li teoria cômica,
De trocadilhos maldosos e piadas estúpidas a bigornas que caem na sua cabeça.</TEXTAREA></TD>
</TR></TABLE>

<H3>Ajustes no tipo e resultados das comparações</H3>
<P>
Esta implementação funciona caracter por caracter, o que é ideal para identificar mudanças sutis nos textos, no entanto o resultado pode conter "exageros", ou seja, pequenas coincidências irrelevantes que complicam a leitura.
As opções abaixo permitem um ajuste fino do webapp para que o resultado atinja as expectativas de legibilidade.</P>
<DL>
<DT><INPUT TYPE="radio" NAME="cleanup" ID="semantic" CHECKED>
<LABEL FOR="semantic">Limpeza Semântica</LABEL></DT>
<DD>Aumenta a legibilidade humana ao remover coincidências que provavelmente são
coincidentais.</DD>
<DT><INPUT TYPE="radio" NAME="cleanup" ID="efficiency">
<LABEL FOR="efficiency">Limpeza de Eficiência</LABEL>,
custo de edição: <INPUT TYPE="text" SIZE=3 MAXLENGTH=5 VALUE="4" ID="editcost">
<DD>Aumenta a eficiência computacional ao remover curtas coincidências que não valem
o overhead. Quanto maior o custo de edição, mais agressiva a limpeza.</DD>
<DT><INPUT TYPE="radio" NAME="cleanup" ID="raw">
<LABEL FOR="raw">Sem Limpeza</LABEL></DT>
<DD>Exibe a comparação sem modificações (saída bruta).</DD>
</DL>

<H3>Tempo limite de processamento da comparação:</H3>
<P><INPUT TYPE="text" SIZE=3 MAXLENGTH=5 VALUE="1" ID="timeout"> segundos<BR>
Se a fase de cálculo de diferenças levar mais tempo que isso, então o cálculo
é interrompido e a melhor solução até o momento é retornada. Este recurso é útil para comparações que estejam travando. Defina um tempo limite de '0' permite o melhor resultado possível independente do tempo.</P>


<H3>Modificar as cores:</H3>
<P>Escolha a cor para marcar todo o conteúdo <strong>adicionado</strong>: <input type="color" id="colorPickerAdd" value="#f56666" onchange="changeColorAdd()"></P>
<P>Escolha a cor para marcar todo o conteúdo <strong>removido ou substituído</strong>: <input type="color" id="colorPickerSub" value="#9ac775" onchange="changeColorSub()"></P>

<P><INPUT TYPE="button" onClick="launch()" VALUE="Fazer comparação"> 
<INPUT TYPE="button" onClick="downloadHtml()" VALUE="Exportar resultado como HTML"></P>

<DIV ID="outputdiv"></DIV>

</FORM>




<HR>
Código adaptado por Erick C. Campos a partir do excelente <A HREF="https://github.com/google/diff-match-patch">Diff, Match e Patch</A>

</BODY>
</HTML>
